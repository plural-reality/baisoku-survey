#!/usr/bin/env bash
# ============================================================
# Sonar デプロイスクリプト（サーバー上で実行）
#
# 使い方:
#   ssh deploy@your-server
#   cd /opt/sonar
#   bash deploy/scripts/deploy.sh
# ============================================================

set -euo pipefail

APP_DIR="/opt/sonar"

echo "=== Sonar: デプロイ開始 ==="
cd "$APP_DIR"

# ------------------------------------------------------------------
# 1. 最新コードを取得
# ------------------------------------------------------------------
echo "[1/5] git pull..."
git pull origin develop

# ------------------------------------------------------------------
# 2. 依存関係インストール
# ------------------------------------------------------------------
echo "[2/5] npm ci..."
npm ci

# ------------------------------------------------------------------
# 3. Next.js ビルド（standalone モード）
# ------------------------------------------------------------------
echo "[3/5] npm run build..."
npm run build

# ------------------------------------------------------------------
# 4. standalone に静的ファイルをコピー
# ------------------------------------------------------------------
echo "[4/5] 静的ファイルコピー..."
cp -r .next/static .next/standalone/.next/static
cp -r public .next/standalone/public

# ------------------------------------------------------------------
# 5. アプリ再起動
# ------------------------------------------------------------------
echo "[5/5] サービス再起動..."
sudo systemctl restart sonar

echo ""
echo "=== デプロイ完了 ==="
echo "  アプリ状態確認: sudo systemctl status sonar"
echo "  ログ確認:       sudo journalctl -u sonar -f"
